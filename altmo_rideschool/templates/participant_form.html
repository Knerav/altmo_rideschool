{% extends "application.html" %}
{% block head %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>                      
{% endblock %}

{% block title %} Homepage {% endblock %}
      
{% block content %}
    <div class="container" style="margin-top: 150px;">
        <h1>Participant Form</h1>
        <form class="my-form" id="participantForm" action="/submit" method="POST" onsubmit="return validateRegistrationForm();">
            <label for="participant_name">Name:</label>
            <input type="text" id="participant_name" name="participant_name" required>

            <label for="participant_email">Email:</label>
            <input type="email" id="participant_email" name="participant_email" required onblur="validateEmail()">
            <span id="email_error" class="error"></span>

            <label for="participant_contact">Contact No:</label>
            <input type="tel" id="participant_contact" name="participant_contact" required onblur="validateContact()">
            <span id="contact_error" class="error"></span>
        
            <label for="participant_address">Address:</label>
            <textarea id="participant_address" name="participant_address"></textarea>

            <label for="participant_age">Age:</label>
            <select id="participant_age" name="participant_age">
                <option value="">Select age range</option>
                <option value="5-10">5-10</option>
                <option value="11-20">11-20</option>
                <option value="21-30">21-30</option>
                <option value="31-40">31-40</option>
                <option value="41-50">41-50</option>
                <option value="51-60">51-60</option>
                <option value="61-70">61-70</option>
            </select>

            <label for="participant_gender">Gender:</label>
            <select id="participant_gender" name="participant_gender">
                <option value="">Select gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Others">Others</option>
            </select>
        
            <label for="training_location">Training Location:</label>
            <select id="training_location" name="training_location" onchange="showAddress()" required>
                <option value="">Select a location</option>
                {% for training_location in training_locations %}
                <option value="{{ training_location.training_location }}" data-address="{{ training_location.training_location_address }}">{{ training_location.training_location }}</option>
                {% endfor %}
            </select>
            <p id="training_location_address"></p>

            <input type="submit" value="Register" id="submitBtn" onclick="submitForm()">
        </form>
        <div class="alert" id="messageAlert" style="display: none;"></div>
        <br>
        <p class="text-center">If you have already registered, please create an account to login : <a href="/signup">Create an account  </a></p>
    </div> 
  
   
    <script> 
        function validateEmail() {
            var emailInput = document.getElementById("participant_email");
            var email = emailInput.value.trim();
            var emailError = document.getElementById("email_error");    
    
            if (email.length > 0) { // it  checks if the email is not empty and then then if emails is there it checks 
                var atIndex = email.indexOf("@");//it checks if it contains @ nd .
                var dotIndex = email.lastIndexOf(".");
                if (atIndex < 1 || dotIndex < (atIndex + 2) || (dotIndex + 2) >= email.length) { // depending on the validation it sets nd adds the error or removes the error class frm the input
                    emailError.textContent = "Invalid email address. Email should contain @ and .";
                    emailInput.classList.add("error");
                } else {
                    emailError.textContent = "";
                    emailInput.classList.remove("error");
                }
            } else {
                emailError.textContent = "";
                emailInput.classList.remove("error");
            }
        }
        function validateContact() {
            var contactInput = document.getElementById("participant_contact");
            var contact = contactInput.value.trim();
            var contactError = document.getElementById("contact_error");
    
            if (contact.length > 0) { //It checks if the contact number is not empty 
                if (contact.length !== 10 || !/^\d{10}$/.test(contact)) { // checks whether it consists of exactly 10 digits if it does not contain exactly 10 digit it is considered  invalid.
                    contactError.textContent = "Invalid contact number. Contact number should consist of 10 digits.";
                    contactInput.classList.add("error");
                } else {
                    contactError.textContent = "";
                    contactInput.classList.remove("error");
                }
            } else {
                contactError.textContent = "";
                contactInput.classList.remove("error");
            }
        }
        function showAddress() { // js function named showaddress
            var select = document.getElementById("training_location"); //gets an HTML element with the id "training_location" and stores it in the variable select which is displayed as a dropdown list
            var address = document.getElementById("training_location_address");  //gets an HTML element with the id "training_location_address" and stores it in the variable address, this is where the address information will be displayed.
            var selectedOption = select.options[select.selectedIndex];// It retrieves the currently selected option from the select element and stores it in the variable selectedOption. This allows you to access the data associated with the selected option.
            address.textContent = selectedOption.getAttribute("data-address");// it  updates the displayed address by taking the value stored in the "data-address" attribute of the selected option in a dropdown and setting it as the visible text for the address element.
        }
    </script>
    <script>
        // Function to display a message in the alert box , so in an alert box it will have things/parameters message, success( colour  if success  true =green , false= red )
        function displayMessage(message, success) { //takes two parameters: message and success. ,,,message: It defines the text message to display in an alert box ,, and success: It determines the styling of the alert box; true makes it green for success, and false makes it red for an error. 
            var alertElement = document.getElementById('messageAlert');//It retrieves an HTML element with the ID 'messageAlert' from the current HTML document and stores it in the variable alertElement.
            alertElement.style.display = 'block';// It makes the alert box visible by changing its CSS display property to 'block'.
            alertElement.innerHTML = message;// It sets the content inside the alert box to the value of the message parameter, dynamically updating what's displayed.
            alertElement.classList.remove('alert-success', 'alert-danger');//It removes the CSS classes 'alert-success' and 'alert-danger' from the alertElement to reset its styling.
            alertElement.classList.add(success ? 'alert-success' : 'alert-danger');// It adds a CSS class ('alert-success' for success or 'alert-danger' for error) to the alertElement based on the value of the success parameter to style the alert box accordingly.
        }
            
        // Function to submit the form (with formid participantForm) to the server asynchronously (without reloading the whole page).
        function submitForm() {
            var form = document.getElementById('participantForm');
            var formData = new FormData(form);
            var submitButton = document.getElementById('submitBtn'); // this is the id which is set in the submit button 
            // Disable the submit button to prevent multiple submissions
            submitButton.disabled = true;

            $.ajax({
                url: '/submit',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(data) {
                    handleResponse(data);
                },
                error: function() {
                    handleResponse('An error occurred. Please try again later.');
                }
            });
        }

        function handleResponse(message) {
            var alertType = message.includes('successfully') ? 'alert-success' : 'alert-danger';
            var alertHTML = '<div class="alert ' + alertType + '">' + message + '</div>';
            var messageContainer = $('#messageAlert');
            messageContainer.html(alertHTML).show();

            if (alertType === 'alert-success') {
                setTimeout(function() {
                    window.location.href = '/signup';
                }, 3000);
            }

            setTimeout(function() {
                $('#participantForm')[0].reset();
                messageContainer.hide();
                // Re-enable the submit button
                var submitButton = document.getElementById('submitBtn');
                submitButton.disabled = false;
            }, 3000);
        }

        $(document).ready(function() {
            $('#participantForm').submit(function(event) {
                event.preventDefault();

                if (!validateRegistrationForm()) {
                    return false;
                }
                submitForm();
            });
        });
    </script>   
{% endblock %}